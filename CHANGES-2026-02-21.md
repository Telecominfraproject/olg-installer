# VM Mode Support and ISO Attachment Fix

## Date: 2026-02-21

## Problem
After fresh ISO install, VyOS VM would not boot:
- `virsh console` hung with no output
- VNC showed "No bootable device" error
- VyOS installation ISO was not persistently attached to VM

## Root Cause
The `setup-vyos-bridge.sh` script used `--cdrom` flag in `virt-install`, which only temporarily attaches the ISO.

## Solution
- Replace `--cdrom` with explicit `--disk path=...,device=cdrom`
- Add `--boot cdrom,hd` to set explicit boot order
- Make setup script instructions VM-mode aware

## Files Changed
- `iso-files/setup-vyos-bridge.sh`: Fixed ISO attachment, added VM mode detection
- `docs/VM-MODE-SETUP.md`: New comprehensive VM mode guide

## Critical Discovery: RouterArchitects Custom VyOS ISO Required

### Issue
After initial VM mode setup, cloud configuration push failed with:
```
DEBUG: Raw VyOS API response: {"detail":"Not Found"}
ERROR: VyOS merge failed
```

### Investigation
Checking VyOS API endpoints revealed only `/info` endpoint available:
```bash
curl -k https://192.168.3.42/openapi.json
# Only showed: "/info": {"get": {...}}
# Missing: /config-file, /configure, /retrieve, /show
```

Compared minimal VyOS config against factory config - found missing `rest` keyword:
```bash
# Factory config has:
set service https api rest

# Our minimal config was missing this line
```

### Root Cause
The standard VyOS rolling release ISO lacks full REST API support. The RouterArchitects custom VyOS ISO includes:
- Enhanced HTTPS API with `/config-file` endpoint
- Full REST API endpoints needed for cloud config push
- This is why `setup-config` defaults to RouterArchitects ISO URL

### Solution
1. **Use RouterArchitects ISO** (already configured in `setup-config`):
   ```bash
   ISO_URL="https://github.com/RouterArchitects/vyos-rolling-build/releases/download/v1.5.0-RC-20251213-0020/vyos-1.5-rolling-202512130020-generic-amd64.iso"
   ```

2. **Minimal VyOS Configuration** for cloud management:
   ```bash
   set interfaces ethernet eth0 address dhcp
   set interfaces ethernet eth0 description WAN
   set service https api
   set service https api keys id ucentral key 'MY-HTTPS-API-PLAINTEXT-KEY'
   set service https api rest  # CRITICAL - enables full REST API
   commit
   save
   ```

3. **DO NOT use factory config** - causes conflicts with cloud-driven configs

### Verification
After adding `set service https api rest`:
- Full API endpoints available: `/config-file`, `/configure`, `/retrieve`, `/show`
- Cloud config push successful: 4 VLANs created (1, 100, 101, 1000)
- DHCP servers configured correctly on all VLANs
- End-to-end flow working: cloud → ucentral → VyOS API → config applied

## Testing
- Verified on MS-01 hardware with VM mode
- VyOS boots successfully from persistent ISO
- SSH access works (VyOS IP: 192.168.3.44)
- Serial console works after install (chose 'S' during `install image`)
- Cloud configuration push tested and verified:
  - 4 VLANs created: 1, 100, 101, 1000
  - DHCP ranges: 150, 200, 200, 4000 IPs respectively
  - All interfaces up: br0, br1, br1.100, br1.101, br1.1000
  - Configuration applied with `{"error":0,"text":"Success"}`
